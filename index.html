<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>x-LLM - Multimodal AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600&display=swap');
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    .logo-font { font-family: 'Space Grotesk', sans-serif; }
    #chatContainer pre { background: #111; color: #fff; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 10px 0; }
    .message-bubble img { max-width: 200px; border-radius: 8px; margin-top: 8px; border: 1px solid #444; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #7c3aed; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors duration-200">

<div id="loading" class="fixed inset-0 flex items-center justify-center bg-zinc-950 z-[100]">
  <div class="text-center">
    <div class="w-16 h-16 bg-gradient-to-br from-violet-600 to-fuchsia-600 rounded-2xl flex items-center justify-center text-3xl font-bold logo-font text-white mx-auto shadow-2xl animate-bounce">X</div>
    <div class="mt-4 text-xl font-bold logo-font text-violet-500">x-LLM Engine</div>
  </div>
</div>

<div id="app" class="hidden flex h-screen overflow-hidden">
  <aside id="sidebar" class="fixed md:static z-40 w-72 h-full bg-white dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300">
    <div class="p-6 flex items-center gap-3 border-b dark:border-zinc-800">
      <div class="w-8 h-8 bg-violet-600 rounded-lg flex items-center justify-center font-bold text-white">X</div>
      <span class="font-bold text-2xl logo-font tracking-tighter">x-LLM</span>
      <button id="closeSidebar" class="md:hidden ml-auto text-xl">&times;</button>
    </div>
    <button id="newChatBtn" class="m-4 bg-violet-600 text-white py-3 rounded-xl font-semibold hover:bg-violet-700 transition shadow-lg shadow-violet-600/20">+ New Conversation</button>
    <div id="chatList" class="flex-1 overflow-y-auto px-4 space-y-2"></div>
    <div class="p-4 border-t dark:border-zinc-800 space-y-2">
      <button id="settingsBtn" class="w-full text-left px-4 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition flex items-center gap-3"><i class="fa-solid fa-gear"></i> Settings</button>
      <button id="darkToggle" class="w-full text-left px-4 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition flex items-center gap-3"><i class="fa-solid fa-moon"></i> Appearance</button>
    </div>
  </aside>

  <div class="flex-1 flex flex-col w-full relative">
    <header class="h-16 flex items-center justify-between px-6 border-b dark:border-zinc-800 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md">
      <button id="openSidebar" class="md:hidden text-xl"><i class="fa-solid fa-bars-staggered"></i></button>
      <div class="flex-1 text-center font-semibold text-zinc-500 text-sm md:text-base">x-LLM v2.0 <span id="modelBadge" class="bg-violet-100 dark:bg-violet-900/30 text-violet-600 px-2 py-0.5 rounded ml-2 text-[10px]"></span></div>
      <div class="w-6"></div>
    </header>

    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40"></main>

    <input type="file" id="fileInput" class="hidden" accept="image/*">
    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment">

    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-zinc-50 dark:from-zinc-950 via-zinc-50 dark:via-zinc-950 to-transparent">
      <div class="max-w-4xl mx-auto">
        <div id="attachmentPreview" class="hidden mb-3 p-3 bg-violet-50 dark:bg-violet-900/20 rounded-2xl border border-violet-200 dark:border-violet-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="previewThumb" class="w-10 h-10 rounded bg-zinc-200 dark:bg-zinc-800 overflow-hidden"></div>
                <span id="fileNameDisplay" class="text-xs font-medium"></span>
            </div>
            <button id="removeFile" class="text-red-500 hover:bg-red-50 p-1 rounded-full">&times;</button>
        </div>
        
        <div class="flex gap-2 items-end bg-white dark:bg-zinc-900 p-2 rounded-2xl border dark:border-zinc-800 shadow-xl focus-within:ring-2 focus-within:ring-violet-500 transition-all">
          <div class="relative group">
              <button id="plusBtn" class="bg-zinc-100 dark:bg-zinc-800 p-3 rounded-xl hover:bg-violet-100 dark:hover:bg-violet-900/40 text-violet-600 transition">
                  <i class="fa-solid fa-plus"></i>
              </button>
              <div id="plusMenu" class="hidden absolute bottom-full left-0 mb-2 bg-white dark:bg-zinc-800 border dark:border-zinc-700 rounded-xl shadow-2xl p-2 w-40 flex flex-col gap-1">
                  <button onclick="document.getElementById('fileInput').click()" class="text-left p-2 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg flex items-center gap-2 text-sm"><i class="fa-solid fa-image"></i> Gallery</button>
                  <button onclick="document.getElementById('cameraInput').click()" class="text-left p-2 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg flex items-center gap-2 text-sm"><i class="fa-solid fa-camera"></i> Camera</button>
              </div>
          </div>
          
          <textarea id="messageInput" class="flex-1 bg-transparent border-none p-3 outline-none resize-none max-h-32 text-sm md:text-base" rows="1" placeholder="Describe or ask x-LLM..."></textarea>
          
          <button id="voiceBtn" class="p-3 text-zinc-400 hover:text-violet-500 transition">
              <i class="fa-solid fa-microphone"></i>
          </button>
          
          <button id="sendBtn" class="bg-violet-600 text-white p-3 rounded-xl hover:bg-violet-700 transition shadow-lg shadow-violet-600/30">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
        <p class="text-[10px] text-center mt-3 text-zinc-500">x-LLM can process images and text. Responses may vary.</p>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4">
  <div class="bg-white dark:bg-zinc-900 p-8 rounded-3xl w-full max-w-md border dark:border-zinc-800 shadow-2xl">
    <h2 class="text-2xl font-bold logo-font mb-6">Engine Configuration</h2>
    <div class="space-y-4">
        <div><label class="text-xs font-bold uppercase text-zinc-500">OpenRouter API Key</label><input id="apiKeyInput" type="password" class="w-full bg-zinc-100 dark:bg-zinc-800 p-3 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-violet-500"></div>
        <div><label class="text-xs font-bold uppercase text-zinc-500">Vision Model (e.g., google/gemini-pro-1.5)</label><input id="modelInput" type="text" class="w-full bg-zinc-100 dark:bg-zinc-800 p-3 rounded-xl mt-1 outline-none"></div>
    </div>
    <div class="flex gap-3 mt-8">
        <button id="closeSettings" class="flex-1 py-3 rounded-xl bg-zinc-100 dark:bg-zinc-800 font-medium">Cancel</button>
        <button id="saveSettings" class="flex-1 py-3 rounded-xl bg-violet-600 text-white font-bold">Save Changes</button>
    </div>
  </div>
</div>

<script>
(function(){
let chats = JSON.parse(localStorage.getItem("xllm_chats") || "[]");
let currentChatId = localStorage.getItem("xllm_currentId") || null;
let apiKey = localStorage.getItem("xllm_key") || "";
let model = localStorage.getItem("xllm_model") || "google/gemini-flash-1.5-8b";
let darkMode = localStorage.getItem("xllm_dark") === "true";
let selectedFileBase64 = null;

// Initialization
const app = document.getElementById("app");
const loading = document.getElementById("loading");
if (darkMode) document.documentElement.classList.add("dark");

function saveState(){
  localStorage.setItem("xllm_chats", JSON.stringify(chats));
  localStorage.setItem("xllm_currentId", currentChatId);
  localStorage.setItem("xllm_key", apiKey);
  localStorage.setItem("xllm_model", model);
  localStorage.setItem("xllm_dark", darkMode);
}

// Plus Menu
document.getElementById("plusBtn").onclick = (e) => {
    e.stopPropagation();
    document.getElementById("plusMenu").classList.toggle("hidden");
};
document.addEventListener("click", () => document.getElementById("plusMenu").classList.add("hidden"));

// File handling
function handleFile(file) {
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        selectedFileBase64 = e.target.result;
        document.getElementById("attachmentPreview").classList.remove("hidden");
        document.getElementById("fileNameDisplay").innerText = "Image Attached: " + file.name;
        document.getElementById("previewThumb").innerHTML = `<img src="${selectedFileBase64}" class="w-full h-full object-cover">`;
    };
    reader.readAsDataURL(file);
}

document.getElementById("fileInput").onchange = (e) => handleFile(e.target.files[0]);
document.getElementById("cameraInput").onchange = (e) => handleFile(e.target.files[0]);
document.getElementById("removeFile").onclick = () => {
    selectedFileBase64 = null;
    document.getElementById("attachmentPreview").classList.add("hidden");
};

// Voice Input (NLP/Speech-to-Text)
const voiceBtn = document.getElementById("voiceBtn");
const messageInput = document.getElementById("messageInput");

if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => voiceBtn.classList.add("text-red-500", "animate-pulse");
    recognition.onend = () => voiceBtn.classList.remove("text-red-500", "animate-pulse");
    recognition.onresult = (event) => {
        messageInput.value = event.results[0][0].transcript;
        messageInput.focus();
    };

    voiceBtn.onclick = () => recognition.start();
} else {
    voiceBtn.style.display = "none";
}

function createChat(){
  const chat = { id: Date.now().toString(), title: "New Chat", messages: [] };
  chats.unshift(chat);
  currentChatId = chat.id;
  saveState();
  renderChats();
  renderMessages();
}

function renderChats(){
  const list = document.getElementById("chatList");
  list.innerHTML = "";
  chats.forEach(chat=>{
    const div = document.createElement("div");
    div.className = `p-3 rounded-xl cursor-pointer transition flex justify-between items-center group ${chat.id === currentChatId ? 'bg-violet-100 dark:bg-violet-900/30 text-violet-600' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-500'}`;
    div.innerHTML = `<span class="truncate text-sm font-medium">${chat.title}</span><button class="opacity-0 group-hover:opacity-100 text-xs hover:text-red-500 transition" onclick="deleteChat('${chat.id}', event)">ðŸ—‘</button>`;
    div.onclick = ()=>{ currentChatId = chat.id; saveState(); renderChats(); renderMessages(); };
    list.appendChild(div);
  });
}

window.deleteChat = (id, e) => {
    e.stopPropagation();
    chats = chats.filter(c => c.id !== id);
    if(currentChatId === id) currentChatId = chats[0]?.id || null;
    if(!currentChatId) createChat();
    saveState(); renderChats(); renderMessages();
};

function renderMessages(){
  const container = document.getElementById("chatContainer");
  container.innerHTML = "";
  const chat = chats.find(c => c.id === currentChatId);
  if (!chat) return;
  chat.messages.forEach(msg=>{
    const div = document.createElement("div");
    div.className = msg.role === "user" ? "flex justify-end" : "flex justify-start";
    
    let imageHtml = msg.image ? `<img src="${msg.image}">` : "";
    
    const bubble = document.createElement("div");
    bubble.className = msg.role === "user" 
        ? "bg-violet-600 text-white p-4 rounded-2xl rounded-tr-none max-w-[85%] shadow-lg message-bubble" 
        : "bg-white dark:bg-zinc-900 border dark:border-zinc-800 p-4 rounded-2xl rounded-tl-none max-w-[85%] shadow-sm message-bubble";
    
    bubble.innerHTML = `${imageHtml}<div>${marked.parse(msg.content)}</div>`;
    div.appendChild(bubble);
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

async function streamResponse(payloadMessages){
  const chat = chats.find(c => c.id === currentChatId);
  const container = document.getElementById("chatContainer");
  
  const aiDiv = document.createElement("div");
  aiDiv.className = "flex justify-start";
  const bubble = document.createElement("div");
  bubble.className = "bg-white dark:bg-zinc-900 border dark:border-zinc-800 p-4 rounded-2xl rounded-tl-none max-w-[85%] shadow-sm";
  bubble.innerHTML = `<div class="loader"></div> <span class="text-xs text-zinc-500">x-LLM analyzing...</span>`;
  aiDiv.appendChild(bubble);
  container.appendChild(aiDiv);
  container.scrollTop = container.scrollHeight;

  let fullText = "";
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method:"POST",
      headers:{ "Authorization":"Bearer "+apiKey, "Content-Type":"application/json" },
      body: JSON.stringify({ model:model, messages:payloadMessages })
    });
    
    const data = await response.json();
    if(data.choices) {
        fullText = data.choices[0].message.content;
        bubble.innerHTML = marked.parse(fullText);
        chat.messages.push({role:"assistant", content:fullText});
        saveState();
    } else {
        bubble.innerHTML = "Error: Check your API Key or Model selection.";
    }
  } catch(e) { bubble.innerHTML = "Network connection failed."; }
}

async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text && !selectedFileBase64) return;
  if(!apiKey) { showSettings(); return; }

  const chat = chats.find(c => c.id === currentChatId);
  if(chat.messages.length === 0 && text) chat.title = text.substring(0, 20);

  const userMsg = { role: "user", content: text, image: selectedFileBase64 };
  chat.messages.push(userMsg);
  
  // API Payload construction
  let apiMsgContent = [{ type: "text", text: text || "Analyze this image." }];
  if(selectedFileBase64) {
      apiMsgContent.push({
          type: "image_url",
          image_url: { url: selectedFileBase64 }
      });
  }

  const payload = chat.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content }));
  payload.push({ role: "user", content: apiMsgContent });

  messageInput.value="";
  selectedFileBase64 = null;
  document.getElementById("attachmentPreview").classList.add("hidden");
  renderMessages();
  saveState();
  
  await streamResponse(payload);
}

// Handlers
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("newChatBtn").onclick = createChat;
document.getElementById("darkToggle").onclick = ()=>{ darkMode = !darkMode; document.documentElement.classList.toggle("dark"); saveState(); };
function showSettings(){ document.getElementById("settingsModal").classList.remove("hidden"); document.getElementById("apiKeyInput").value = apiKey; document.getElementById("modelInput").value = model; }
document.getElementById("settingsBtn").onclick = showSettings;
document.getElementById("closeSettings").onclick = ()=> document.getElementById("settingsModal").classList.add("hidden");
document.getElementById("saveSettings").onclick = ()=>{ apiKey = document.getElementById("apiKeyInput").value.trim(); model = document.getElementById("modelInput").value.trim(); saveState(); document.getElementById("settingsModal").classList.add("hidden"); document.getElementById("modelBadge").innerText = model; };
document.getElementById("openSidebar").onclick = ()=> document.getElementById("sidebar").classList.remove("-translate-x-full");
document.getElementById("closeSidebar").onclick = ()=> document.getElementById("sidebar").classList.add("-translate-x-full");

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

if(chats.length === 0) createChat();
document.getElementById("modelBadge").innerText = model;
renderChats(); renderMessages();
setTimeout(() => { loading.style.display = "none"; app.classList.remove("hidden"); }, 1000);
})();
</script>
</body>
</html>

